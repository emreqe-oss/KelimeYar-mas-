rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // "users" koleksiyonu için kurallar
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // "games" koleksiyonu için kurallar
    match /games/{gameId} {
      // Giriş yapmış herhangi bir kullanıcı, bir oyunun bilgilerini okuyabilir.
      allow read: if request.auth != null;

      // Giriş yapmış herhangi bir kullanıcı, yeni bir oyun oluşturabilir.
      allow create: if request.auth != null;

      // Bir oyunu GÜNCELLEMEK (Katılma/Hamle Yapma) ve SİLMEK için kurallar:
      allow update, delete: if 
        // 1. Ya oyunun içindeki bir oyuncu olmalısın (Hamle, skor güncelleme vs.)
        request.auth.uid in resource.data.players 

        // 2. YA DA oyun beklemedeyse ve sen henüz oyuncu değilsen (Rastgele Oyuna Katılma)
        || (resource.data.status == 'waiting' && !(request.auth.uid in resource.data.players))

        // 3. YA DA oyun sana davet edilmişse (Daveti Kabul Etme veya Reddetme için SİLME)
        || request.auth.uid == resource.data.invitedPlayerId;
    }

    // "friendships" koleksiyonu için kurallar
    match /friendships/{friendshipId} {
      allow read, update, delete: if request.auth.uid in resource.data.users;
      allow create: if request.auth != null;
    }
  }
}