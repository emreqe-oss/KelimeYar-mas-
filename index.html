<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Kelime Oyunu - Çok Oyunculu</title>
    <meta name="theme-color" content="#111827"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%3E%3Crect%20width='180'%20height='180'%20x='6'%20y='10'%20rx='32'%20fill='%23b45309'/%3E%3Crect%20width='180'%20height='180'%20x='6'%20y='6'%20rx='32'%20fill='%23f59e0b'/%3E%3Ctext%20x='50%25'%20y='50%25'%20dy='.1em'%20dominant-baseline='central'%20text-anchor='middle'%20font-size='110'%20font-family='Inter,%20sans-serif'%20font-weight='bold'%20fill='%23ffffff'%3EK%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { 
            height: 100vh; 
            height: -webkit-fill-available;
            overflow: hidden; 
        }
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; display: flex; flex-direction: column; }
        .tile { 
            width: 100%; 
            padding-bottom: 100%; 
            position: relative; 
            border: 2px solid #4b5563; 
            display: flex;
            justify-content: center; 
            align-items: center;
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: bold; 
            text-transform: uppercase; 
            transition: all 0.3s ease; 
        }
        .tile-inner { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1;
        }
        .tile.correct { background-color: #10b981; border-color: #10b981; color: white; }
        .tile.present { background-color: #f59e0b; border-color: #f59e0b; color: white; }
        .tile.absent { background-color: #374151; border-color: #374151; color: white; }
        .tile.failed { background-color: #ef4444; border-color: #ef4444; color: white; }
        .keyboard-key { 
            transition: background-color 0.2s; 
            height: 40px; /* Yükseklik daha da azaltıldı */
            font-size: 0.8rem; /* Font boyutu küçültüldü */
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .keyboard-key.correct { background-color: #10b981 !important; color: white; }
        .keyboard-key.present { background-color: #f59e0b !important; color: white; }
        .keyboard-key.absent { background-color: #374151 !important; color: white; }
        .toast { visibility: hidden; opacity: 0; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; transform: translateX(-50%); bottom: 50px; transition: opacity 0.5s, visibility 0.5s, bottom 0.5s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 70px; }
        .pulsate { animation: pulsate-bck 1s ease-in-out infinite both; }
        @keyframes pulsate-bck { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="app" class="w-full max-w-md mx-auto flex flex-col h-full p-2">
        
        <!-- Oyun Modu Seçim Ekranı -->
        <div id="mode-selection-screen" class="text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
            <h1 class="text-4xl font-bold text-center mb-6">Kelime Yarışması</h1>
            <input type="text" id="username-input" placeholder="Kullanıcı Adını Gir" class="w-full p-3 border rounded-md bg-gray-700 border-gray-600 mb-6 text-center text-white text-lg" maxlength="12">
            <div class="space-y-4">
                 <button id="single-player-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>Tek Kişilik Oyna</button>
                 <button id="vs-cpu-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>Bilgisayara Karşı Oyna</button>
                 <button id="multiplayer-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>İki Kişilik (Online)</button>
            </div>
        </div>

        <!-- Çok Oyunculu Kurulum Ekranı -->
        <div id="multiplayer-setup-screen" class="hidden text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
             <button id="back-to-mode-btn" class="absolute top-4 left-4 text-sm text-gray-400 hover:text-white">&lt; Geri</button>
            <h1 class="text-3xl font-bold text-center mb-6">İki Kişilik Oyun</h1>
            <div class="mb-4">
                <h2 class="text-2xl font-semibold mb-3">Yeni Oyun Kur</h2>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label for="word-length-select" class="block text-sm font-medium text-gray-400">Harf</label>
                        <select id="word-length-select" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                        </select>
                    </div>
                     <div>
                        <label for="time-select" class="block text-sm font-medium text-gray-400">Süre</label>
                        <select id="time-select" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="30">30sn</option>
                            <option value="45" selected>45sn</option>
                            <option value="60">60sn</option>
                        </select>
                    </div>
                    <div>
                        <label for="match-length-select" class="block text-sm font-medium text-gray-400">Tur</label>
                        <select id="match-length-select" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="1">1</option>
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>
                <button id="create-game-btn" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>Oyun Kur</button>
            </div>
            <hr class="my-4 border-gray-600">
            <div>
                <h2 class="text-2xl font-semibold mb-3">Oyuna Katıl</h2>
                <input type="text" id="game-id-input" placeholder="Oyun ID'sini girin" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 mb-3 text-center uppercase text-white placeholder-red-500">
                <button id="join-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>Oyuna Katıl</button>
            </div>
        </div>

        <!-- Oyun Ekranı -->
        <div id="game-screen" class="hidden flex-1 flex flex-col items-center">
             <div class="w-full bg-gray-800 p-2 rounded-lg shadow flex items-center justify-between flex-shrink-0">
                <div id="player1-score" class="text-left w-2/5 truncate"></div>
                <div class="text-center w-1/5">
                    <p id="round-counter" class="text-xs text-gray-400"></p>
                    <p id="turn-display" class="font-bold text-md"></p>
                    <p id="timer-display" class="font-bold text-xl font-mono text-gray-300"></p>
                </div>
                <div id="player2-score" class="text-right w-2/5 truncate"></div>
            </div>
            
            <div id="game-info-bar" class="w-full text-center py-1 flex justify-between items-center px-2 flex-shrink-0">
                 <p class="text-xs">Oyun ID: <strong id="game-id-display" class="text-indigo-400"></strong></p>
                 <button id="leave-game-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Ayrıl</button>
            </div>
            
            <div class="w-full flex-grow flex flex-col justify-center min-h-0">
                <div id="guess-grid" class="grid gap-1 w-full" style="max-width: 320px; margin: 0 auto;"></div>
            </div>

            <button id="start-game-btn" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg text-lg my-1 flex-shrink-0">Oyunu Başlat</button>
            <div id="keyboard" class="w-full flex-shrink-0"></div>
        </div>
        
        <!-- Maç Sonucu Ekranı -->
        <div id="scoreboard-screen" class="hidden text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
            <h2 id="round-winner-display" class="text-3xl font-bold mb-2"></h2>
            <h3 id="match-winner-display" class="text-2xl font-bold mb-4 text-yellow-400"></h3>
            <p class="mb-4">Doğru Kelime: <strong id="correct-word-display" class="text-green-400"></strong></p>
            <div id="final-scores" class="w-full max-w-xs mx-auto mb-6 text-left"></div>
            <button id="new-round-btn" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg text-lg mb-3">Yeni Tur</button>
            <button id="main-menu-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Ana Menü</button>
        </div>

    </div>
    <div id="toast" class="toast"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // --- KELİME LİSTELERİ ---
        const wordLists = {
            4: ["ARSA", "BALE", "CEZA", "DERS", "EKŞİ", "FAKS", "GÖLGE", "HANE", "ISKA", "JÖLE", "KALE", "LİRA", "MODA", "NEŞE", "OKUL", "PARA", "ROTA", "SAHA", "ŞANS", "TEMA", "UYKU", "VİDA", "YAZI", "ZEKA"],
            5: ["AJANS", "BALIK", "CEVİZ", "DÜNYA", "ELMAS", "FIRIN", "GAZAP", "HABER", "İHALE", "JETON", "KALEM", "LİMON", "MOTOR", "NEFES", "PİLOT", "RADYO", "SEBZE", "ŞEKER", "TAVUK", "UZMAN", "VAGON", "YENGE", "ZAMAN", "ERKEK"],
            6: ["ADALET", "BAHANE", "CİNAYET", "DİKKAT", "EFSANE", "FELAKET", "GELENEK", "HİKAYE", "İSKELE", "JAPONYA", "KELİME", "LOKANTA", "MARKET", "NUMARA", "OTOMAT", "PARFÜM", "REKLAM", "SANDAL", "ŞAMPİYON", "TERAZİ", "UFUKLAR", "VİTAMİN", "YAPRAK", "ZİYARET"],
            7: ["BAKLAVA", "CESARET", "DOKTOR", "FESTİVAL", "GALERİ", "HAZİRAN", "İHTİYAÇ", "JENERİK", "KARANFİL", "MAKİNİST", "NİSAN", "OKYANUS", "PANTOLON", "REÇETE", "SALINCAK", "ŞEMSİYE", "TELEFON", "UYGARLIK", "VİTRİN", "YARDIMCI", "ZARAFET"]
        };
        const validWords = {
            4: [...new Set(wordLists[4].concat(["ALAN", "ALAY", "ALGI", "ALIM", "AYAK", "AYAR", "AYET", "AYIP", "AYNI", "AZAR", "BANT", "BARI", "BATI", "BİNA", "BORÇ", "CİLT", "ÇATI", "ÇITA", "DAMA", "DANS", "DAVA", "DENK", "DİSK", "EBAT", "EDAT", "EKİM", "EMİR", "ESER", "ETAP", "ETİK", "FAİZ", "FİİL", "FİLM", "GAZA", "GEMİ", "GIDA", "GÖÇ", "GREV", "GÜÇ", "HACI", "HALI", "HARÇ", "HATA", "İKNA", "İLAÇ", "İMAL", "İMAR", "İSİM", "İŞÇİ", "KAPI", "KARE", "KASA", "KIŞ", "KITA", "LİSE", "MAAŞ", "MOLA", "NAR", "NOT", "ODA", "ODUN", "OLAY", "OLTA", "ONAY", "ORAN", "ÖDÜL", "ÖLÇÜ", "ÖMÜR", "ÖYKÜ", "POTA", "RANT", "RİSK", "SAVA", "SAYI", "SEÇİM", "SOBA", "ŞİİR", "TANE", "TEST", "TİPİ", "TREN", "VAAT", "VERİ", "YAKA", "YARI", "YASA", "YURT", "ZARF", "ETKİ", "YAPI"]))],
            5: [...new Set(wordLists[5].concat(["ADRES", "AHLAK", "AKŞAM", "ALBÜM", "ALKOL", "ALTIN", "ARABA", "AROMA", "ASİT", "ATLET", "AYDIN", "BAHAR", "BANKA", "BARDAK", "BAŞLIK", "BEYAZ", "BİLET", "BİLGİ", "BİREY", "BORSA", "BÖLGE", "CAMİ", "CEVAP", "CİHAZ", "ÇADIR", "ÇANTA", "ÇARŞI", "ÇİÇEK", "DAİRE", "DEKAN", "DENİZ", "DERGİ", "DİVAN", "DOĞA", "DOĞRU", "DOLAR", "DRAMA", "DÜZEN", "EGOİST", "EKRAN", "EMLAK", "ENERJİ", "EVRAK", "FATURA", "FİNAL", "FOTO", "GAZETE", "GELİR", "GİTAR", "GÖMLEK", "GÖREV", "GÜNEŞ", "HAKEM", "HAKİM", "HALK", "HARİTA", "HASTA", "HEDEF", "HESAP", "HUKUK", "İÇERİK", "İKLİM", "İNSAN", "İPTAL", "İŞLEM", "KADIN", "KAHVE", "KANAL", "KANUN", "KARAR", "KARGO", "KASKO", "KAVRAM", "KAYIT", "KİTAP", "KLİMA", "KOLTUK", "KREDİ", "KURAL", "KURUM", "LİDER", "LİSTE", "MARKA", "MASA", "MODEL", "MÜZİK", "NÜFUS", "OPERA", "OTEL", "ÖNERİ", "ÖZEL", "PASTA", "PERDE", "PLAKA", "POLİS", "POSTA", "PROJE", "RAKAM", "RAPOR", "ROMAN", "SAAT", "SABAH", "SAHNE", "SANAT", "SATIR", "SEANS", "SEFER", "SENET", "SERGİ", "SEVİYE", "SINAV", "SİNEMA", "SİSTEM", "SOKAK", "SPOR", "STRES", "ŞARAP", "ŞEHİR", "ŞİRKET", "TABLO", "TARİH", "TASARI", "TATİL", "TEKLİF", "TEKNİK", "TERMOS", "VİDEO", "VİLLA", "YASAL", "YAZAR", "YEMEK", "ZEMİN", "ÇEVRE", "GARAJ", "METRO", "PLAJ"]))],
            6: [...new Set(wordLists[6].concat(["AİLECE", "ANALİZ", "ANKET", "ARŞİV", "ATÖLYE", "BANYO", "BASKET", "BENZİN", "BERBER", "CADDE", "CENAZE", "CERRAH", "CETVEL", "CÜZDAN", "ÇÖZÜM", "DEKOR", "DERNEK", "DİPLOMA", "DOLMUŞ", "DÖVİZ", "DÜKKAN", "ECZANE", "EĞİTİM", "ENDİŞE", "FELSEFE", "FİHRİST", "FİZİK", "FUTBOL", "GARSON", "GELECEK", "GENETİK", "GİRİŞİM", "GÖZLÜK", "GRAFİK", "GRAMER", "GÜMRÜK", "HABERCİ", "HALKLA", "HAMSİ", "HAREKET", "HASTANE", "HAYALET", "HAYVAN", "HAZİNE", "HEDİYE", "HEKİM", "HEMŞİRE", "HEYECAN", "HİZMET", "HÜKÜMET", "İÇECEK", "İHRACAT", "İMALAT", "İMTİHAN", "İNANÇ", "İNŞAAT", "İPUCU", "İŞARET", "İTHALAT", "İTİRAZ", "JEST", "JOKEY", "JÜRİ", "KABİNE", "KADEME", "KALORİ", "KAMERA", "KANSER", "KAYNAK", "KAZANÇ", "KİMYA", "KİRALIK", "KLASÖR", "KORİDOR", "KOSTÜM", "KULÜP", "KURBAN", "KURYE", "KÜLTÜR", "LİSANS", "LOKMA", "MAKALE", "MAKYAJ", "MANZARA", "MEKANİK", "MEKTUP", "MEMUR", "MERKEZ", "MESAFE", "MESLEK", "MEVZUAT", "MİMAR", "MİSAFİR", "MÜZE", "NEMRUT", "OTOBÜS", "ÖLÇEK", "ÖNERGE", "ÖNSÖZ", "ÖRNEK", "REÇEL", "REFAKAT", "REHBER", "REJİM", "RUHSAT", "SAĞLIK", "SANAYİ", "SANTRAL", "SEKTÖR", "SEMİNER", "SENDİKA", "SERMAYE", "SEYAHAT", "SİNYAL", "SİPARİŞ", "SİYASET", "SÖZLÜK", "ŞANTAJ", "ŞEFFAF", "ŞİKAYET", "TAKVİM", "TALİMAT", "TAMİR", "TARİFE", "TEBLİĞ", "TEDAVİ", "TEHLİKE", "TEKSTİL", "TEMİNAT", "TEORİ", "TERCİH", "TERÖR", "TESİS", "TİCARET", "TRAFİK", "TÜRKÇE", "ÜCRET", "ÜNİTE", "ÜRETİM", "ÜSLUP", "VAKIF", "VERGİ", "VİZE", "YABANCI", "YARIŞMA", "YATIRIM", "YAZILIM", "YETENEK", "TEŞVİK", "BİLGİN", "CİVCİV", "FORMÜL", "GAZETE", "MÜZEVİR", "ENGELLİ", "EVLİLİK", "GÜVENLİK", "İŞLETME"]))],
            7: [...new Set(wordLists[7].concat(["ADLİYE", "AİDAT", "AJANDA", "AKRABA", "AKSİYON", "ALERJİ", "ALFABE", "AMATÖR", "AMBALAJ", "ANAYASA", "ASANSÖR", "ASİSTAN", "ATÖLYE", "AVUKAT", "BAŞARI", "BAŞKENT", "BAŞVURU", "BİLANÇO", "BÜTÇE", "CANAVAR", "CİMRİLİK", "ÇAMAŞIR", "ÇİFTLİK", "ÇİZELGE", "ÇOCUK", "DENEYİM", "DESTEK", "DETAYLI", "DEVLET", "DİKKATLİ", "DİNAMİK", "DİPLOMAT", "DİREKTÖR", "DİZAYN", "DOMATES", "DÖNEM", "DÜŞÜNCE", "ECZACI", "EDİTÖR", "EGZERSİZ", "EKİPMAN", "EKOLOJİ", "ELBİSE", "EMEKLİ", "EMNİYET", "EMPATİ", "ERGENLİK", "ESTETİK", "ETİKET", "FİNANS", "FREKANS", "GELİŞİM", "GENÇLİK", "GEREKÇE", "GEZEGEN", "GÖSTERGE", "GÖZLEM", "GRAM", "GREV", "GÜNDEM", "GÜVEN", "HAKİKAT", "HARABE", "HATIRA", "HAYAL", "HAYAT", "HEMŞERİ", "HİJYEN", "HİKAYE", "HİSSE", "HOBİ", "HOŞGÖRÜ", "HÜRRİYET", "IŞIK", "İÇERİK", "İDEOLOJİ", "İHALE", "İHTİMAL", "İSKELET", "İSTİFA", "İSTİKRAR", "İŞLETİM", "JEST", "JEOLOJİ", "KALİTE", "KAMUOYU", "KANIT", "KARAKOL", "KARDEŞ", "KASABA", "KAVGA", "KAYGI", "KELEBEK", "KİMLİK", "KLASİK", "KOMEDİ", "KONFOR", "KONSEY", "KORUMA", "KOZMİK", "KRİTER", "KURULUŞ", "KÜRESEL", "LOBİ", "MAKİNE", "MALİYET", "MANEVRA", "MASKE", "MEDYA", "MELODİ", "MENAJER", "MESAİ", "MEVSİM", "MEYDAN", "MİSYON", "MODERN", "MÜLAKAT", "NAKLİYE", "NEGATİF", "NESİL", "NİHAYET", "NÖTR", "OBJE", "OFİS", "OKSİJEN", "OTORİTE", "ÖĞÜT", "ÖNCELİK", "ÖZLEM", "PAKET", "PANİK", "PARALEL", "PARAZİT", "PARFÜM", "PARTİ", "PASİF", "PEYZAJ", "PİRAMİT", "POLEMİK", "POPÜLER", "PORTFÖY", "POZİTİF", "PRENSİP", "PRESTİJ", "PROGRAM", "PROTEİN", "PROVA", "RADİKAL", "REALİTE", "REKABET", "REPLİKA", "RİTİM", "RUTİN", "RÜŞVET", "SABOTAJ", "SADAKAT", "SALDIRI", "SANDVİÇ", "SAVAŞÇI", "SENARYO", "SEMBOL", "SEMPATİ", "SENTEZ", "SERVİS", "SEVİMLİ", "SEZON", "SIHHAT", "SİGARA", "SİLÜET", "SİVİL", "SLOGAN", "SOSYAL", "SÖYLEM", "SPONSOR", "STATÜ", "STİL", "SÜREÇ", "ŞÖVALYE", "TAAHHÜT", "TABİAT", "TAKDİR", "TAKIM", "TAKVİYE", "TALEP", "TASARIM", "TAVSİYE", "TECRÜBE", "TEDARİK", "TEHDİT", "TEKST", "TEMA", "TEMEL", "TERAPİ", "TERİM", "TESADÜF", "TRAJEDİ", "TRANSİT", "TÜNEL", "UYDU", "UYUM", "ÜNİFORM", "ÜSLUP", "VADE", "VAHŞET", "VAKUM", "VARLIK", "YAYINCI", "YETKİ", "YILAN", "YORUMCU", "YÜZDE", "ZANAAT", "ZARİF", "EPİDEMİ", "İŞLETİM", "MARATON", "VİTAMİN", "GANİMET", "FAKÜLTE", "ŞELALE", "SİYASET", "TİYATRO"]))]
        };
        
        window.addEventListener('load', () => {
            // --- DOM Elements ---
            const modeSelectionScreen = document.getElementById('mode-selection-screen');
            const multiplayerSetupScreen = document.getElementById('multiplayer-setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const scoreboardScreen = document.getElementById('scoreboard-screen');
            const guessGrid = document.getElementById('guess-grid');
            const keyboardContainer = document.getElementById('keyboard');
            const toast = document.getElementById('toast');
            const turnDisplay = document.getElementById('turn-display');
            const timerDisplay = document.getElementById('timer-display');
            const createBtn = document.getElementById('create-game-btn');
            const joinBtn = document.getElementById('join-game-btn');
            const mainMenuBtn = document.getElementById('main-menu-btn');
            const newRoundBtn = document.getElementById('new-round-btn');
            const leaveGameBtn = document.getElementById('leave-game-button');
            const gameIdDisplay = document.getElementById('game-id-display');
            const startGameBtn = document.getElementById('start-game-btn');
            const roundCounter = document.getElementById('round-counter');
            
            // --- Global State ---
            let db, auth, userId, currentGameId = null, gameUnsubscribe = null, turnTimerInterval = null, localGameData = null, gameMode = null;
            let currentRow = 0, isMyTurn = false, isGameOver = false, wordLength = 5, timeLimit = 45;
            
            // --- Scoring ---
            const scorePoints = [1000, 800, 600, 400, 200, 100];
            const GUESS_COUNT = 6;

            // --- Sound Effects ---
            const sounds = {
                click: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
                error: new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(),
                win: new Tone.PolySynth(Tone.Synth).toDestination(),
                lose: new Tone.PolySynth(Tone.Synth).toDestination(),
                draw: new Tone.PolySynth(Tone.Synth).toDestination()
            };
            function playSound(sound) {
                if (Tone.context.state !== 'running') { Tone.context.resume(); }
                switch(sound) {
                    case 'click': sounds.click.triggerAttackRelease('C5', '8n'); break;
                    case 'error': sounds.error.triggerAttackRelease('C3', '8n'); break;
                    case 'win': sounds.win.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '8n', Tone.now()); break;
                    case 'lose': sounds.lose.triggerAttackRelease(['C4', 'A3', 'F3', 'D3'], '8n', Tone.now()); break;
                    case 'draw': sounds.draw.triggerAttackRelease(['C4', 'G4'], '8n', Tone.now()); break;
                }
            }

            // --- Firebase Config ---
            const firebaseConfig = {
                apiKey: "AIzaSyA5FcmgM9GV79qGwS8MC3_4yCvwvHZO0iQ",
                authDomain: "kelime-oyunu-flaneur.firebaseapp.com",
                projectId: "kelime-oyunu-flaneur",
                storageBucket: "kelime-oyunu-flaneur.appspot.com",
                messagingSenderId: "888546992121",
                appId: "1:888546992121:web:3e29748729cca6fbbb2728",
                measurementId: "G-RVD6YZ8JYV"
            };

            // --- Utility Functions ---
            function showToast(message, isError = false) {
                if (isError) playSound('error');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
            
            function getUsername() {
                let username = document.getElementById('username-input').value.trim();
                return username ? username.slice(0, 12) : `Oyuncu${Math.floor(Math.random() * 900) + 100}`;
            }

            function showScreen(screenId) {
                ['mode-selection-screen', 'multiplayer-setup-screen', 'game-screen', 'scoreboard-screen'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }
            
            function setupAndStartGame(mode) {
                gameMode = mode;
                wordLength = parseInt(document.getElementById('word-length-select').value);
                timeLimit = parseInt(document.getElementById('time-select').value);
                const username = getUsername();
                
                const secretWord = wordLists[wordLength][Math.floor(Math.random() * wordLists[wordLength].length)];
                
                localGameData = {
                    wordLength, secretWord, timeLimit, currentRound: 1, matchLength: 1,
                    players: { [userId]: { username, guesses: [], score: 0 } },
                    currentPlayerId: userId, status: 'playing', turnStartTime: new Date()
                };

                if (gameMode === 'vsCPU') {
                    localGameData.players['cpu'] = { username: 'Bilgisayar', guesses: [], score: 0 };
                }
                
                showScreen('game-screen');
                renderGameState(localGameData);
            }

            async function createGame() {
                if (!db || !auth || !userId) return showToast("Sunucuya bağlanılamıyor.", true);
                
                gameMode = 'multiplayer';
                const username = getUsername();
                const selectedLength = parseInt(document.getElementById('word-length-select').value);
                const selectedTime = parseInt(document.getElementById('time-select').value);
                const selectedMatchLength = parseInt(document.getElementById('match-length-select').value);
                const gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const secretWord = wordLists[selectedLength][Math.floor(Math.random() * wordLists[selectedLength].length)];

                const gameData = {
                    gameId, wordLength: selectedLength, secretWord, timeLimit: selectedTime, creatorId: userId,
                    matchLength: selectedMatchLength, currentRound: 1,
                    players: { [userId]: { username, guesses: [], score: 0 } },
                    currentPlayerId: userId, status: 'waiting', roundWinner: null, createdAt: new Date(),
                    turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    await firebase.firestore().collection("games").doc(gameId).set(gameData);
                    await joinGame(gameId);
                } catch (error) { console.error("Error creating game:", error); showToast("Oyun oluşturulamadı!", true); }
            }

            async function joinGame(gameId) {
                if (!db || !auth || !userId) return showToast("Sunucuya bağlanılamıyor.", true);
                if (!gameId) return showToast("Lütfen bir Oyun ID'si girin.", true);
                
                gameMode = 'multiplayer';
                const username = getUsername();
                const gameRef = db.collection("games").doc(gameId);
                
                try {
                    const gameDoc = await gameRef.get();
                    if (!gameDoc.exists) return showToast("Oyun bulunamadı!", true);

                    const gameData = gameDoc.data();
                    
                    if (Object.keys(gameData.players).length === 1 && !gameData.players[userId]) {
                        await gameRef.update({ [`players.${userId}`]: { username, guesses: [], score: 0 } });
                    } else if (!gameData.players[userId]) {
                        return showToast("Bu oyun dolu veya başlamış.", true);
                    }

                    currentGameId = gameId;
                    showScreen('game-screen');
                    listenToGameUpdates(gameId);
                } catch (error) { console.error("Error joining game:", error); showToast("Oyuna katılırken hata oluştu.", true); }
            }

            function listenToGameUpdates(gameId) {
                if (gameUnsubscribe) gameUnsubscribe();
                const gameRef = db.collection("games").doc(gameId);
                gameUnsubscribe = gameRef.onSnapshot((doc) => {
                    const gameData = doc.data();
                    if (!gameData) {
                        showToast("Oyun sonlandırıldı.");
                        leaveGame();
                        return;
                    }
                    localGameData = gameData;
                    if (gameData.status === 'finished') {
                        showScoreboard(gameData);
                    } else {
                        renderGameState(gameData);
                    }
                });
            }
            
            function leaveGame() {
                if (gameUnsubscribe) gameUnsubscribe();
                stopTurnTimer();
                gameUnsubscribe = null;
                currentGameId = null;
                localGameData = null;
                gameMode = null;
                showScreen('mode-selection-screen');
            }

            function renderGameState(gameData) {
                showScreen('game-screen');

                document.getElementById('game-id-display').textContent = gameMode === 'multiplayer' ? gameData.gameId : 'Tek Kişilik';
                document.getElementById('game-info-bar').style.display = gameMode === 'multiplayer' ? 'flex' : 'none';
                if (gameMode === 'multiplayer') {
                    roundCounter.textContent = `Tur ${gameData.currentRound}/${gameData.matchLength}`;
                } else {
                    roundCounter.textContent = '';
                }
                
                wordLength = gameData.wordLength;
                timeLimit = gameData.timeLimit || 45;
                isMyTurn = gameData.currentPlayerId === userId && gameData.status === 'playing';
                isGameOver = gameData.status === 'finished';
                
                updateTurnDisplay(gameData);
                updateScores(gameData);
                createGrid();

                const playerIds = Object.keys(gameData.players);
                let totalGuesses = 0;
                let turnOrder = playerIds;
                
                if(gameData.creatorId && playerIds.length > 1 && playerIds.indexOf(gameData.creatorId) > 0) {
                    turnOrder = [gameData.creatorId, ...playerIds.filter(p => p !== gameData.creatorId)];
                }

                for(let i = 0; i < GUESS_COUNT; i++) {
                    for(const playerId of turnOrder) {
                        const player = gameData.players[playerId];
                        if(player.guesses && player.guesses[i]) {
                            const { word, colors } = player.guesses[i];
                            renderGuess(totalGuesses, word, colors);
                            totalGuesses++;
                        }
                    }
                }
                
                currentRow = totalGuesses;

                createKeyboard();
                updateKeyboard(gameData);

                startTurnTimer();
            }
            
            function updateScores(gameData) {
                const playerIds = Object.keys(gameData.players);
                const p1ScoreEl = document.getElementById('player1-score');
                const p2ScoreEl = document.getElementById('player2-score');
                let p1Id = playerIds[0];
                if(gameData.creatorId) p1Id = gameData.creatorId;

                if (playerIds.length > 0) {
                    const p1 = gameData.players[p1Id];
                    if(p1) p1ScoreEl.innerHTML = `<span class="font-bold">${p1.username}</span><br>${p1.score} Puan`;
                }
                 if (playerIds.length > 1) {
                    const p2Id = playerIds.find(id => id !== p1Id);
                    const p2 = gameData.players[p2Id];
                    if(p2) p2ScoreEl.innerHTML = `<span class="font-bold">${p2.username}</span><br>${p2.score} Puan`;
                } else if(gameMode !== 'single'){
                    p2ScoreEl.innerHTML = '';
                }
            }

            function updateTurnDisplay(gameData) {
                const numPlayers = Object.keys(gameData.players).length;
                if (gameData.status === 'waiting') {
                    if (numPlayers < 2) {
                        turnDisplay.textContent = "Rakip bekleniyor...";
                        startGameBtn.classList.add('hidden');
                    } else {
                        if (userId === gameData.creatorId) {
                            turnDisplay.textContent = "Rakip katıldı!";
                            startGameBtn.classList.remove('hidden');
                        } else {
                            turnDisplay.textContent = "Başlatılıyor...";
                            startGameBtn.classList.add('hidden');
                        }
                    }
                } else if (gameData.status === 'playing') {
                    startGameBtn.classList.add('hidden');
                    const currentPlayerUsername = gameData.players[gameData.currentPlayerId]?.username;
                    if (isMyTurn) {
                        turnDisplay.textContent = "Sıra Sende!";
                        turnDisplay.classList.add('pulsate');
                    } else {
                        turnDisplay.textContent = `Sıra: ${currentPlayerUsername}`;
                        turnDisplay.classList.remove('pulsate');
                    }
                }
            }

            function createGrid() {
                guessGrid.innerHTML = '';
                guessGrid.style.gridTemplateColumns = `repeat(${wordLength}, 1fr)`;
                for (let i = 0; i < GUESS_COUNT; i++) {
                    for (let j = 0; j < wordLength; j++) {
                        const tile = document.createElement('div');
                        tile.classList.add('tile');
                        tile.id = `tile-${i}-${j}`;
                        const tileInner = document.createElement('div');
                        tileInner.classList.add('tile-inner');
                        tile.appendChild(tileInner);
                        guessGrid.appendChild(tile);
                    }
                }
            }

            function renderGuess(rowIndex, word, colors) {
                 for (let i = 0; i < wordLength; i++) {
                    const tile = document.getElementById(`tile-${rowIndex}-${i}`);
                    if(tile) {
                        tile.querySelector('.tile-inner').textContent = word[i];
                        tile.classList.add(colors[i]);
                    }
                }
            }

            function createKeyboard() {
                keyboardContainer.innerHTML = '';
                const keyRows = [
                    ['E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P', 'Ğ', 'Ü'],
                    ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'Ş', 'İ'],
                    ['Z', 'C', 'V', 'B', 'N', 'M', 'Ö', 'Ç']
                ];

                keyRows.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.classList.add('flex', 'justify-center', 'gap-1', 'my-1');
                    row.forEach(key => {
                        const keyButton = document.createElement('button');
                        keyButton.textContent = key;
                        keyButton.classList.add('keyboard-key', 'rounded-md', 'font-semibold', 'uppercase', 'bg-gray-500', 'flex-1');
                        keyButton.onclick = () => handleKeyPress(key);
                        rowDiv.appendChild(keyButton);
                    });
                    keyboardContainer.appendChild(rowDiv);
                });

                const specialKeysRow = document.createElement('div');
                specialKeysRow.classList.add('flex', 'justify-center', 'gap-1', 'my-1');
                
                const backspaceKey = document.createElement('button');
                backspaceKey.textContent = '⌫';
                backspaceKey.classList.add('keyboard-key', 'rounded-md', 'font-semibold', 'uppercase', 'bg-gray-600', 'px-4');
                backspaceKey.style.flexGrow = '1.5';
                backspaceKey.onclick = () => handleKeyPress('⌫');
                specialKeysRow.appendChild(backspaceKey);

                const enterKey = document.createElement('button');
                enterKey.textContent = 'ENTER';
                enterKey.classList.add('keyboard-key', 'rounded-md', 'font-semibold', 'uppercase', 'bg-gray-600', 'flex-grow');
                enterKey.style.flexGrow = '6';
                enterKey.onclick = () => handleKeyPress('ENTER');
                specialKeysRow.appendChild(enterKey);


                keyboardContainer.appendChild(specialKeysRow);
            }


            function updateKeyboard(gameData) {
                const allGuesses = Object.values(gameData.players).flatMap(p => p.guesses);
                const keyStates = {};
                allGuesses.forEach(({ word, colors }) => {
                    for (let i = 0; i < word.length; i++) {
                        const letter = word[i];
                        const color = colors[i];
                        if (keyStates[letter] === 'correct') continue;
                        if (keyStates[letter] === 'present' && color !== 'correct') continue;
                        keyStates[letter] = color;
                    }
                });
                document.querySelectorAll('.keyboard-key').forEach(btn => {
                    const letter = btn.textContent;
                    const state = keyStates[letter];
                    btn.classList.remove('correct', 'present', 'absent');
                    if (state) btn.classList.add(state);
                });
            }
            
            function startTurnTimer() {
                stopTurnTimer();
                if(isGameOver) return;

                let turnStartTime = (gameMode === 'multiplayer' && localGameData.turnStartTime?.toDate) 
                    ? localGameData.turnStartTime.toDate() 
                    : new Date();

                turnTimerInterval = setInterval(async () => {
                    let now = new Date();
                    let elapsed = Math.floor((now - turnStartTime) / 1000);
                    let timeLeft = timeLimit - elapsed;
                    
                    if(timerDisplay) timerDisplay.textContent = timeLeft > 0 ? timeLeft : 0;
                    
                    if (timeLeft <= 5) timerDisplay.classList.add('text-red-500');
                    else timerDisplay.classList.remove('text-red-500');

                    if (timeLeft <= 0 && isMyTurn) { 
                        stopTurnTimer(); 
                        await failTurn(''); 
                    }
                }, 1000);
            }

            function stopTurnTimer() {
                clearInterval(turnTimerInterval);
                turnTimerInterval = null;
                if (timerDisplay) timerDisplay.textContent = '';
            }
            
            async function failTurn(guessWord = '') {
                if (!isMyTurn) return;
                stopTurnTimer();
                keyboardContainer.style.pointerEvents = 'none';

                const newGuess = { 
                    word: guessWord.padEnd(wordLength, ' '), 
                    colors: Array(wordLength).fill('failed') 
                };

                if (gameMode === 'multiplayer') {
                    const gameRef = db.collection("games").doc(currentGameId);
                    const gameDoc = await gameRef.get();
                    if (!gameDoc.exists) return;
                    const gameData = gameDoc.data();

                    const playerGuesses = gameData.players[userId].guesses || [];
                    playerGuesses.push(newGuess);
                    
                    const playerIds = Object.keys(gameData.players);
                    const myIndex = playerIds.indexOf(userId);
                    const nextPlayerIndex = (myIndex + 1) % playerIds.length;
                    
                    const updates = {
                        [`players.${userId}.guesses`]: playerGuesses,
                        currentPlayerId: playerIds[nextPlayerIndex],
                        turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const totalGuesses = Object.values(gameData.players).reduce((sum, p) => sum + p.guesses.length, 0);
                    if (totalGuesses >= GUESS_COUNT * playerIds.length) {
                        updates.status = 'finished';
                        updates.roundWinner = null;
                    }
                    await gameRef.update(updates).finally(() => { keyboardContainer.style.pointerEvents = 'auto'; });
                } else {
                    localGameData.players[userId].guesses.push(newGuess);
                    const totalGuessesMade = Object.values(localGameData.players).reduce((acc, p) => acc + p.guesses.length, 0);

                    if (totalGuessesMade >= GUESS_COUNT) {
                        localGameData.status = 'finished';
                        showScoreboard(localGameData);
                    } else {
                        if (gameMode === 'vsCPU') {
                            localGameData.currentPlayerId = 'cpu';
                            renderGameState(localGameData);
                            setTimeout(cpuTurn, 1500);
                        } else {
                           renderGameState(localGameData);
                        }
                    }
                    keyboardContainer.style.pointerEvents = 'auto';
                }
            }


            function handleKeyPress(key) {
                if (isGameOver || !isMyTurn) return;
                
                const processedKey = key.toLocaleUpperCase('tr-TR');
                if (processedKey === 'ENTER') {
                    playSound('click');
                    submitGuess();
                } else if (processedKey === '⌫' || processedKey === 'BACKSPACE') {
                    playSound('click');
                    deleteLetter();
                } else if (processedKey.length === 1 && processedKey.match(/[A-ZÇĞİÖŞÜ]/)) {
                    addLetter(processedKey);
                }
            }
            
            function addLetter(letter) {
                let added = false;
                for (let i = 0; i < wordLength; i++) {
                    const tile = document.getElementById(`tile-${currentRow}-${i}`);
                    if (tile && tile.querySelector('.tile-inner').textContent === '') {
                        tile.querySelector('.tile-inner').textContent = letter;
                        playSound('click');
                        added = true;
                        break;
                    }
                }
                if(!added) {
                    playSound('error');
                }
            }

            function deleteLetter() {
                for (let i = wordLength - 1; i >= 0; i--) {
                    const tile = document.getElementById(`tile-${currentRow}-${i}`);
                    if (tile && tile.querySelector('.tile-inner').textContent !== '') {
                        tile.querySelector('.tile-inner').textContent = '';
                        break;
                    }
                }
            }

            async function submitGuess() {
                if (!isMyTurn) return;
                
                let guessWord = '';
                for (let i = 0; i < wordLength; i++) {
                    const tile = document.getElementById(`tile-${currentRow}-${i}`);
                    const tileInner = tile.querySelector('.tile-inner');
                    if (!tileInner || tileInner.textContent === '') { showToast("Kelime yeterince uzun değil!", true); return; }
                    guessWord += tileInner.textContent;
                }
                
                if (!validWords[wordLength] || !validWords[wordLength].includes(guessWord)) {
                    showToast("Kelime sözlükte bulunamadı!", true);
                    await failTurn(guessWord);
                    return;
                }
                
                keyboardContainer.style.pointerEvents = 'none';
                stopTurnTimer();
                
                const secretWord = localGameData.secretWord;
                const colors = calculateColors(guessWord, secretWord);
                const newGuess = { word: guessWord, colors: colors };

                if (gameMode === 'multiplayer') {
                    const gameRef = db.collection("games").doc(currentGameId);
                    const gameDoc = await gameRef.get();
                    const gameData = gameDoc.data();
                    
                    const playerGuesses = gameData.players[userId].guesses || [];
                    playerGuesses.push(newGuess);

                    const playerIds = Object.keys(gameData.players);
                    const myIndex = playerIds.indexOf(userId);
                    const nextPlayerIndex = (myIndex + 1) % playerIds.length;
                    
                    const updates = {
                        [`players.${userId}.guesses`]: playerGuesses,
                        currentPlayerId: playerIds[nextPlayerIndex],
                        turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const totalGuessesMade = Object.values(gameData.players).reduce((sum, p) => sum + p.guesses.length, 0) + 1;
                    
                    if (guessWord === secretWord) {
                        updates.status = 'finished';
                        updates.roundWinner = userId;
                        const scoreToAdd = scorePoints[Math.floor(currentRow / playerIds.length)] || 0;
                        updates[`players.${userId}.score`] = (gameData.players[userId].score || 0) + scoreToAdd;
                    } else if (totalGuessesMade >= GUESS_COUNT) {
                        updates.status = 'finished';
                        updates.roundWinner = null; 
                    }
                    await gameRef.update(updates).finally(() => { keyboardContainer.style.pointerEvents = 'auto'; });
                } else {
                     // Single Player & vs CPU logic
                    localGameData.players[userId].guesses.push(newGuess);
                    
                    if (guessWord === secretWord) {
                        localGameData.status = 'finished';
                        localGameData.roundWinner = userId;
                        const scoreToAdd = scorePoints[currentRow] || 0;
                        localGameData.players[userId].score += scoreToAdd;
                        showScoreboard(localGameData);
                    } else {
                        const totalGuessesMade = Object.values(localGameData.players).reduce((acc, p) => acc + p.guesses.length, 0);
                        if (totalGuessesMade >= GUESS_COUNT) {
                            localGameData.status = 'finished';
                            localGameData.roundWinner = null;
                            showScoreboard(localGameData);
                        } else {
                            if (gameMode === 'vsCPU') {
                                localGameData.currentPlayerId = 'cpu';
                                renderGameState(localGameData);
                                setTimeout(cpuTurn, 1500);
                            } else {
                                renderGameState(localGameData);
                            }
                        }
                    }
                    keyboardContainer.style.pointerEvents = 'auto';
                }
            }
            
            function showScoreboard(gameData) {
                stopTurnTimer();
                showScreen('scoreboard-screen');

                const roundWinnerDisplay = document.getElementById('round-winner-display');
                const correctWordDisplay = document.getElementById('correct-word-display');
                const finalScores = document.getElementById('final-scores');
                const matchWinnerDisplay = document.getElementById('match-winner-display');
                
                if(gameData.roundWinner === userId) playSound('win');
                else if(gameData.roundWinner === null) playSound('draw');
                else playSound('lose');

                correctWordDisplay.textContent = gameData.secretWord;

                if (gameData.roundWinner) {
                    const winnerName = gameData.players[gameData.roundWinner].username;
                    roundWinnerDisplay.textContent = `${winnerName} Turu Kazandı!`;
                } else {
                    roundWinnerDisplay.textContent = "Berabere!";
                }

                finalScores.innerHTML = `<h3 class="text-xl font-bold mb-2 text-center">${gameMode === 'multiplayer' ? 'Toplam Puan' : 'Puan'}</h3>`;
                const sortedPlayers = Object.values(gameData.players).sort((a,b) => b.score - a.score);
                sortedPlayers.forEach(player => {
                    const scoreEl = document.createElement('p');
                    scoreEl.className = 'text-lg';
                    scoreEl.textContent = `${player.username}: ${player.score} Puan`;
                    finalScores.appendChild(scoreEl);
                });
                
                matchWinnerDisplay.textContent = '';
                newRoundBtn.textContent = (gameMode === 'multiplayer') ? 'Yeni Tur' : 'Yeni Kelime';

                if (gameMode === 'multiplayer' && gameData.currentRound >= gameData.matchLength) {
                    newRoundBtn.classList.add('hidden');
                    const p1 = sortedPlayers[0];
                    const p2 = sortedPlayers.length > 1 ? sortedPlayers[1] : {score: -1};
                    if (p1.score > p2.score) {
                         matchWinnerDisplay.textContent = `MAÇI ${p1.username} KAZANDI!`;
                    } else if (p2.score > p1.score) {
                         matchWinnerDisplay.textContent = `MAÇI ${p2.username} KAZANDI!`;
                    } else {
                         matchWinnerDisplay.textContent = 'MAÇ BERABERE!';
                    }
                } else if (userId === gameData.creatorId || gameMode !== 'multiplayer') {
                    newRoundBtn.classList.remove('hidden');
                } else {
                    newRoundBtn.classList.add('hidden');
                }
            }
            
            async function startNewRound() {
                if (gameMode === 'multiplayer') {
                     if (!localGameData) return;
                    
                    const newWordList = wordLists[localGameData.wordLength];
                    const newSecretWord = newWordList[Math.floor(Math.random() * newWordList.length)];
                    
                    const playerIds = Object.keys(localGameData.players);
                    const newPlayersState = {};
                    playerIds.forEach(pid => {
                        newPlayersState[pid] = { ...localGameData.players[pid], guesses: [] };
                    });

                    const updates = {
                        secretWord: newSecretWord, players: newPlayersState,
                        currentPlayerId: localGameData.creatorId, status: 'waiting', roundWinner: null,
                        currentRound: localGameData.currentRound + 1,
                        turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const gameRef = db.collection("games").doc(currentGameId);
                    await gameRef.update(updates);
                } else {
                    if(localGameData.currentRound >= localGameData.matchLength){
                         localGameData.players[userId].score = 0; 
                         if(localGameData.players['cpu']) localGameData.players['cpu'].score = 0;
                    }
                    setupAndStartGame(gameMode);
                }
            }


            function calculateColors(guess, secret) {
                const secretLetters = secret.split('');
                const guessLetters = guess.split('');
                const colors = Array(wordLength).fill('');
                for (let i = 0; i < wordLength; i++) {
                    if (guessLetters[i] === secretLetters[i]) {
                        colors[i] = 'correct';
                        secretLetters[i] = null;
                    }
                }
                for (let i = 0; i < wordLength; i++) {
                    if (colors[i] === '') {
                        const index = secretLetters.indexOf(guessLetters[i]);
                        if (index > -1) {
                            colors[i] = 'present';
                            secretLetters[index] = null;
                        } else {
                            colors[i] = 'absent';
                        }
                    }
                }
                return colors;
            }
            
            // --- EVENT LISTENERS ---
            document.getElementById('single-player-btn').addEventListener('click', () => {
                if (getUsername()) setupAndStartGame('single');
            });
            document.getElementById('vs-cpu-btn').addEventListener('click', () => {
                if (getUsername()) setupAndStartGame('vsCPU');
            });
            document.getElementById('multiplayer-btn').addEventListener('click', () => {
                if (getUsername()) {
                    showScreen('multiplayer-setup-screen');
                }
            });
            document.getElementById('back-to-mode-btn').addEventListener('click', () => showScreen('mode-selection-screen'));

            leaveGameBtn.onclick = leaveGame;
            createBtn.addEventListener('click', createGame);
            joinBtn.addEventListener('click', () => {
                const gameId = document.getElementById('game-id-input').value.toUpperCase();
                joinGame(gameId);
            });
            startGameBtn.addEventListener('click', async () => {
                if (!currentGameId || gameMode !== 'multiplayer') return;
                const gameRef = db.collection("games").doc(currentGameId);
                await gameRef.update({ status: 'playing', turnStartTime: firebase.firestore.FieldValue.serverTimestamp() });
            });
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.altKey || e.metaKey) return;
                handleKeyPress(e.key);
            });
            mainMenuBtn.addEventListener('click', leaveGame);
            newRoundBtn.addEventListener('click', startNewRound);

            // --- Game Startup Logic ---
            if (typeof firebase === 'undefined') {
                showToast("Gerekli dosyalar yüklenemedi. Sayfayı yenileyin.", true);
            } else {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('single-player-btn').disabled = false;
                            document.getElementById('vs-cpu-btn').disabled = false;
                            document.getElementById('multiplayer-btn').disabled = false;
                            createBtn.disabled = false;
                            joinBtn.disabled = false;
                        } else {
                            auth.signInAnonymously().catch(error => { 
                                console.error("Anonymous sign-in failed:", error); 
                                showToast("Bağlantı hatası!", true);
                            });
                        }
                    });
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    showToast("Uygulama başlatılamadı.", true);
                }
            }
        });
    </script>
</body>
</html>

