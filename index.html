<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%3E%3Crect%20width='180'%20height='180'%20x='6'%20y='10'%20rx='32'%20fill='%23b45309'/%3E%3Crect%20width='180'%20height='180'%20x='6'%20y='6'%20rx='32'%20fill='%23f59e0b'/%3E%3Ctext%20x='50%25'%20y='50%25'%20dy='.1em'%20dominant-baseline='central'%20text-anchor='middle'%20font-size='110'%20font-family='Inter,%20sans-serif'%20font-weight='bold'%20fill='%23ffffff'%3EK%3C/text%3E%3C/svg%3E">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Kelime Oyunu - Çok Oyunculu</title>
    <meta name="theme-color" content="#111827"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%3E%3Crect%20width='180'%20height='180'%20x='6'%20y='10'%20rx='32'%20fill='%23b45309'/%3E%3Crect%20width='180'%20height='180'%20x='6'%20y='6'%20rx='32'%20fill='%23f59e0b'/%3E%3Ctext%20x='50%25'%20y='50%25'%20dy='.1em'%20dominant-baseline='central'%20text-anchor='middle'%20font-size='110'%20font-family='Inter,%20sans-serif'%20font-weight='bold'%20fill='%23ffffff'%3EK%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { 
            height: 100vh; 
            height: -webkit-fill-available;
            overflow: hidden; 
        }
        body { font-family: 'Inter', sans-serif; touch-action: manipulation; display: flex; flex-direction: column; transition: background-color 0.3s, color 0.3s; }
        .tile { 
            width: 100%; 
            padding-bottom: 100%; 
            position: relative; 
            border: 2px solid #4b5563; 
            display: flex;
            justify-content: center; 
            align-items: center;
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: bold; 
            text-transform: uppercase; 
            transition: all 0.3s ease; 
        }
        .tile-inner { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1;
        }
        .tile.correct { background-color: #10b981; border-color: #10b981; color: white; }
        .tile.present { background-color: #f59e0b; border-color: #f59e0b; color: white; }
        .tile.absent { background-color: #374151; border-color: #374151; color: white; }
        .tile.failed { background-color: #ef4444; border-color: #ef4444; color: white; }
        .keyboard-key {
            transition: background-color 0.2s;
            height: 48px;
            font-size: 1rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .keyboard-key.correct { background-color: #10b981 !important; color: white; }
        .keyboard-key.present { background-color: #f59e0b !important; color: white; }
        .keyboard-key.absent { background-color: #374151 !important; color: white; }
        .toast { visibility: hidden; opacity: 0; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 100; left: 50%; transform: translateX(-50%); bottom: 50px; transition: opacity 0.5s, visibility 0.5s, bottom 0.5s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 70px; }
        .pulsate { animation: pulsate-bck 1s ease-in-out infinite both; }
        @keyframes pulsate-bck { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Açık Tema Stilleri */
        body.theme-light { background-color: #f1c0e8; color: #1f2937; }
        body.theme-light .bg-gray-800, body.theme-light .bg-gray-900:not(#theme-dark-btn) { background-color: #ffffff; }
        body.theme-light .text-gray-200, body.theme-light .text-white { color: #1f2937; }
        body.theme-light .text-gray-400 { color: #6b7280; }
        body.theme-light .bg-gray-700 { background-color: #f3f4f6; }
        body.theme-light .border-gray-600 { border-color: #d1d5db; }
        body.theme-light .keyboard-key { background-color: #e5e7eb; color: #1f2937; }
        body.theme-light .tile { border-color: #1f2937; }
        body.theme-light #username-input::placeholder { color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="app" class="w-full max-w-md mx-auto flex flex-col h-full p-2">
        
        <div id="mode-selection-screen" class="text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
            <h1 class="text-4xl font-bold text-center mb-6">Kelime Yarışması</h1>
            <input type="text" id="username-input" placeholder="Kullanıcı Adını Gir" class="w-full p-3 border rounded-md bg-gray-700 border-gray-600 mb-6 text-center text-white text-lg" maxlength="12">
            <div class="space-y-4">
                 <button id="single-player-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center gap-2" disabled>
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                     <span>Tek Kişilik Oyna</span>
                 </button>
                 <button id="vs-cpu-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center gap-2" disabled>
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3M5.636 5.636l-1.414-1.414m15.556 15.556l-1.414-1.414M18.364 5.636l-1.414 1.414m-12.728 12.728l-1.414 1.414"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18a6 6 0 100-12 6 6 0 000 12z"></path></svg>
                     <span>Bilgisayara Karşı Oyna</span>
                 </button>
                 <button id="multiplayer-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center gap-2" disabled>
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                     <span>İki Kişilik (Online)</span>
                 </button>
                 <button id="rejoin-game-btn" class="hidden w-full bg-amber-500 hover:bg-amber-600 text-black font-bold py-3 px-4 rounded-lg text-lg mt-4">Devam Et</button>
            </div>
            <div class="mt-6 flex justify-center items-center gap-4">
                <p class="text-sm text-gray-400">Tema:</p>
                <button id="theme-light-btn" class="w-8 h-8 rounded-full border-2 border-gray-500" style="background-color: #f1c0e8;"></button>
                <button id="theme-dark-btn" class="w-8 h-8 rounded-full bg-gray-900 border-2 border-gray-500"></button>
            </div>
            <p id="loading-words" class="text-gray-400 mt-4">Kelimeler yükleniyor...</p>
        </div>

        <div id="singleplayer-setup-screen" class="hidden text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
             <button id="back-to-mode-single-btn" class="absolute top-4 left-4 text-sm text-gray-400 hover:text-white">&lt; Geri</button>
            <h1 id="singleplayer-title" class="text-3xl font-bold text-center mb-6">Oyun Ayarları</h1>
            <div class="mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="word-length-select-single" class="block text-sm font-medium text-gray-400">Harf Sayısı</label>
                        <select id="word-length-select-single" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                     <div>
                        <label for="time-select-single" class="block text-sm font-medium text-gray-400">Tahmin Süresi</label>
                        <select id="time-select-single" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="30">30sn</option>
                            <option value="45" selected>45sn</option>
                            <option value="60">60sn</option>
                        </select>
                    </div>
                </div>
                <button id="start-single-game-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Oyuna Başla</button>
            </div>
        </div>

        <div id="multiplayer-setup-screen" class="hidden text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
             <button id="back-to-mode-multi-btn" class="absolute top-4 left-4 text-sm text-gray-400 hover:text-white">&lt; Geri</button>
            <h1 class="text-3xl font-bold text-center mb-6">İki Kişilik Oyun</h1>
            <div class="mb-4">
                <h2 class="text-2xl font-semibold mb-3">Yeni Oyun Kur</h2>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label for="word-length-select-multi" class="block text-sm font-medium text-gray-400">Harf</label>
                        <select id="word-length-select-multi" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                     <div>
                        <label for="time-select-multi" class="block text-sm font-medium text-gray-400">Süre</label>
                        <select id="time-select-multi" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="30">30sn</option>
                            <option value="45" selected>45sn</option>
                            <option value="60">60sn</option>
                        </select>
                    </div>
                    <div>
                        <label for="match-length-select" class="block text-sm font-medium text-gray-400">Tur</label>
                        <select id="match-length-select" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 text-white">
                            <option value="1">1</option>
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>
                <button id="create-game-btn" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>Oyun Kur</button>
            </div>
            <hr class="my-4 border-gray-600">
            <div>
                <h2 class="text-2xl font-semibold mb-3">Oyuna Katıl</h2>
                <input type="text" id="game-id-input" placeholder="Oyun ID'sini girin" class="w-full p-2 border rounded-md bg-gray-700 border-gray-600 mb-3 text-center uppercase text-white placeholder-red-500">
                <button id="join-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg" disabled>Oyuna Katıl</button>
            </div>
        </div>

        <div id="game-screen" class="hidden flex-1 flex flex-col items-center">
             <div class="w-full bg-gray-800 p-1 rounded-lg shadow flex items-center justify-between flex-shrink-0">
                <div id="player1-score" class="text-left w-2/5 truncate"></div>
                <div class="text-center w-1/5">
                    <p id="round-counter" class="text-xs text-gray-400"></p>
                    <p id="turn-display" class="font-bold text-md"></p>
                    <p id="timer-display" class="font-bold text-xl font-mono text-gray-300"></p>
                </div>
                <div id="player2-score" class="text-right w-2/5 truncate"></div>
            </div>
            
            <div id="game-info-bar" class="w-full text-center py-1 flex justify-between items-center px-2 flex-shrink-0">
                 <div class="flex items-center gap-2">
                     <p class="text-xs">Oyun ID: <strong id="game-id-display" class="text-indigo-400"></strong></p>
                     <button id="copy-game-id-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-0 px-2 rounded text-xs">Kopyala</button>
                     <button id="share-game-btn" class="hidden bg-blue-600 hover:bg-blue-500 text-white font-bold py-0 px-2 rounded text-xs flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                        <span>Paylaş</span>
                    </button>
                 </div>
                 <button id="leave-game-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Ayrıl</button>
            </div>
            
            <div class="w-full flex-grow flex flex-col justify-center min-h-0">
                <div id="guess-grid" class="grid gap-1 w-full" style="margin: 0 auto;"></div>
            </div>

            <button id="start-game-btn" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg text-lg my-1 flex-shrink-0">Oyunu Başlat</button>
            <div id="keyboard" class="w-full flex-shrink-0"></div>
        </div>
        
        <div id="scoreboard-screen" class="hidden text-center bg-gray-800 p-4 rounded-lg shadow-lg flex-1 flex flex-col justify-center">
            <h2 id="round-winner-display" class="text-3xl font-bold mb-2"></h2>
            <h3 id="match-winner-display" class="text-2xl font-bold mb-4 text-yellow-400"></h3>
            <div class="mb-4">
                <p>Doğru Kelime: <strong id="correct-word-display" class="text-green-400 text-xl"></strong></p>
                <p id="word-meaning-display" class="text-sm text-gray-400 mt-2 italic"></p>
            </div>
            <div id="final-scores" class="w-full max-w-xs mx-auto mb-6 text-left"></div>
            <button id="new-round-btn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg mb-3">Yeni Oyun</button>
            <button id="main-menu-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Ana Menü</button>
        </div>

    </div>
    <div id="toast" class="toast"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        let kelimeSozlugu = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            const modeSelectionScreen = document.getElementById('mode-selection-screen');
            const singleplayerSetupScreen = document.getElementById('singleplayer-setup-screen');
            const multiplayerSetupScreen = document.getElementById('multiplayer-setup-screen');
            const gameScreen = document.getElementById('game-screen');
            const scoreboardScreen = document.getElementById('scoreboard-screen');
            const guessGrid = document.getElementById('guess-grid');
            const keyboardContainer = document.getElementById('keyboard');
            const toast = document.getElementById('toast');
            const turnDisplay = document.getElementById('turn-display');
            const timerDisplay = document.getElementById('timer-display');
            const createBtn = document.getElementById('create-game-btn');
            const joinBtn = document.getElementById('join-game-btn');
            const mainMenuBtn = document.getElementById('main-menu-btn');
            const newRoundBtn = document.getElementById('new-round-btn');
            const leaveGameBtn = document.getElementById('leave-game-button');
            const gameIdDisplay = document.getElementById('game-id-display');
            const copyGameIdBtn = document.getElementById('copy-game-id-btn');
            const shareGameBtn = document.getElementById('share-game-btn');
            const startGameBtn = document.getElementById('start-game-btn');
            const roundCounter = document.getElementById('round-counter');
            
            let db, auth, userId, currentGameId = null, gameUnsubscribe = null, turnTimerInterval = null, localGameData = null, gameMode = null;
            let currentRow = 0, isMyTurn = false, isGameOver = false, wordLength = 5, timeLimit = 45;
            let singlePlayerMode = null;
            let gameIdFromUrl = null;
            let heartbeatInterval = null;
            let presenceCheckInterval = null;
            
            const scorePoints = [1000, 800, 600, 400, 200, 100];
            const GUESS_COUNT = 6;

            const sounds = {
                click: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
                error: new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(),
                win: new Tone.PolySynth(Tone.Synth).toDestination(),
                lose: new Tone.PolySynth(Tone.Synth).toDestination(),
                draw: new Tone.PolySynth(Tone.Synth).toDestination()
            };
            function playSound(sound) {
                if (Tone.context.state !== 'running') { Tone.context.resume(); }
                switch(sound) {
                    case 'click': sounds.click.triggerAttackRelease('C5', '8n'); break;
                    case 'error': sounds.error.triggerAttackRelease('C3', '8n'); break;
                    case 'win': sounds.win.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '8n', Tone.now()); break;
                    case 'lose': sounds.lose.triggerAttackRelease(['C4', 'A3', 'F3', 'D3'], '8n', Tone.now()); break;
                    case 'draw': sounds.draw.triggerAttackRelease(['C4', 'G4'], '8n', Tone.now()); break;
                }
            }

            const firebaseConfig = {
                apiKey: "AIzaSyA5FcmgM9GV79qGwS8MC3_4yCvwvHZO0iQ",
                authDomain: "kelime-oyunu-flaneur.firebaseapp.com",
                projectId: "kelime-oyunu-flaneur",
                storageBucket: "kelime-oyunu-flaneur.appspot.com",
                messagingSenderId: "888546992121",
                appId: "1:888546992121:web:3e29748729cca6fbbb2728",
                measurementId: "G-RVD6YZ8JYV"
            };

            function showToast(message, isError = false) {
                if (isError) playSound('error');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
            
            function getUsername() {
                let username = document.getElementById('username-input').value.trim();
                return username ? username.slice(0, 12) : `Oyuncu${Math.floor(Math.random() * 900) + 100}`;
            }

            function showScreen(screenId) {
                ['mode-selection-screen', 'singleplayer-setup-screen', 'multiplayer-setup-screen', 'game-screen', 'scoreboard-screen'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            }

            function initializeGameUI(gameData) {
                wordLength = gameData.wordLength;
                if (wordLength === 4) {
                    guessGrid.style.maxWidth = '220px';
                } else if (wordLength === 5) {
                    guessGrid.style.maxWidth = '280px';
                } else {
                    guessGrid.style.maxWidth = '320px';
                }
                createGrid();
                createKeyboard();
            }

            function setupAndStartGame(mode) {
                gameMode = mode;
                if (mode === 'single' || mode === 'vsCPU') {
                    wordLength = parseInt(document.getElementById('word-length-select-single').value);
                    timeLimit = parseInt(document.getElementById('time-select-single').value);
                }
                const username = getUsername();
                
                const secretWord = kelimeSozlugu[wordLength][Math.floor(Math.random() * kelimeSozlugu[wordLength].length)];
                
                localGameData = {
                    wordLength, secretWord, timeLimit, currentRound: 1, matchLength: 1,
                    players: { [userId]: { username, guesses: [], score: 0 } },
                    currentPlayerId: userId, status: 'playing', turnStartTime: new Date()
                };

                if (gameMode === 'vsCPU') {
                    localGameData.players['cpu'] = { username: 'Bilgisayar', guesses: [], score: 0 };
                }
                
                showScreen('game-screen');
                initializeGameUI(localGameData);
                renderGameState(localGameData);
            }

            async function createGame() {
                if (!db || !auth || !userId) return showToast("Sunucuya bağlanılamıyor.", true);
                
                gameMode = 'multiplayer';
                const username = getUsername();
                const selectedLength = parseInt(document.getElementById('word-length-select-multi').value);
                const selectedTime = parseInt(document.getElementById('time-select-multi').value);
                const selectedMatchLength = parseInt(document.getElementById('match-length-select').value);
                const gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const secretWord = kelimeSozlugu[selectedLength][Math.floor(Math.random() * kelimeSozlugu[selectedLength].length)];

                const gameData = {
                    gameId, wordLength: selectedLength, secretWord, timeLimit: selectedTime, creatorId: userId,
                    matchLength: selectedMatchLength, currentRound: 1,
                    players: { [userId]: { username, guesses: [], score: 0, lastSeen: firebase.firestore.FieldValue.serverTimestamp() } },
                    currentPlayerId: userId, status: 'waiting', roundWinner: null, createdAt: new Date(),
                    turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                try {
                    await firebase.firestore().collection("games").doc(gameId).set(gameData);
                    await joinGame(gameId);
                } catch (error) { console.error("Error creating game:", error); showToast("Oyun oluşturulamadı!", true); }
            }

            async function joinGame(gameId) {
                if (!db || !auth || !userId) return showToast("Sunucuya bağlanılamıyor.", true);
                if (!gameId) return showToast("Lütfen bir Oyun ID'si girin.", true);
                
                gameMode = 'multiplayer';
                const username = getUsername();
                const gameRef = db.collection("games").doc(gameId);
                
                try {
                    const gameDoc = await gameRef.get();
                    if (!gameDoc.exists) {
                        localStorage.removeItem('activeGameId');
                        return showToast("Oyun bulunamadı!", true);
                    }

                    const gameData = gameDoc.data();
                    
                    if (Object.keys(gameData.players).length === 1 && !gameData.players[userId]) {
                        await gameRef.update({ [`players.${userId}`]: { username, guesses: [], score: 0, lastSeen: firebase.firestore.FieldValue.serverTimestamp() } });
                    } else if (!gameData.players[userId]) {
                        return showToast("Bu oyun dolu veya başlamış.", true);
                    }

                    localStorage.setItem('activeGameId', gameId);
                    currentGameId = gameId;
                    showScreen('game-screen');
                    initializeGameUI(gameData);
                    startHeartbeat();
                    listenToGameUpdates(gameId);
                } catch (error) { console.error("Error joining game:", error); showToast("Oyuna katılırken hata oluştu.", true); }
            }

            function listenToGameUpdates(gameId) {
                if (gameUnsubscribe) gameUnsubscribe();
                const gameRef = db.collection("games").doc(gameId);
                gameUnsubscribe = gameRef.onSnapshot((doc) => {
                    const gameData = doc.data();
                    if (!gameData) {
                        showToast("Oyun sonlandırıldı.");
                        leaveGame();
                        return;
                    }
                    localGameData = gameData;
                    if (gameData.status === 'finished') {
                        showScoreboard(gameData);
                    } else {
                        renderGameState(gameData);
                    }
                });
            }
            
            function leaveGame() {
                if (gameUnsubscribe) gameUnsubscribe();
                stopHeartbeat();
                stopPresenceCheck();
                stopTurnTimer();
                localStorage.removeItem('activeGameId');
                gameUnsubscribe = null;
                currentGameId = null;
                localGameData = null;
                gameMode = null;
                showScreen('mode-selection-screen');
                document.getElementById('rejoin-game-btn').classList.add('hidden');
            }

            function renderGameState(gameData) {
                // Bu fonksiyon artık grid veya klavye oluşturmuyor, sadece güncelliyor.
                if (document.getElementById('game-screen').classList.contains('hidden')) {
                    showScreen('game-screen');
                }
                
                document.getElementById('game-id-display').textContent = gameMode === 'multiplayer' ? gameData.gameId : 'Tek Kişilik';
                document.getElementById('game-info-bar').style.display = gameMode === 'multiplayer' ? 'flex' : 'none';
                if (gameMode === 'multiplayer') {
                    roundCounter.textContent = `Tur ${gameData.currentRound}/${gameData.matchLength}`;
                    startPresenceCheck();
                } else {
                    roundCounter.textContent = '';
                }
                
                timeLimit = gameData.timeLimit || 45;
                isMyTurn = gameData.currentPlayerId === userId && gameData.status === 'playing';
                isGameOver = gameData.status === 'finished';
                
                updateTurnDisplay(gameData);
                updateScores(gameData);

                // Grid'i sıfırdan oluşturmak yerine sadece dolu olanları render et
                const allTiles = document.querySelectorAll('.tile');
                allTiles.forEach(tile => {
                    tile.querySelector('.tile-inner').textContent = '';
                    tile.classList.remove('correct', 'present', 'absent', 'failed');
                });

                const playerIds = Object.keys(gameData.players);
                let turnOrder = playerIds;
                
                if(gameMode === 'multiplayer' && gameData.creatorId && playerIds.length > 1 && playerIds.indexOf(gameData.creatorId) > 0) {
                    turnOrder = [gameData.creatorId, ...playerIds.filter(p => p !== gameData.creatorId)];
                } else if(gameMode === 'vsCPU' && playerIds.indexOf('cpu') === 0) {
                    turnOrder = [userId, 'cpu'];
                }

                let totalGuessesRendered = 0;
                const maxGuessesPerPlayer = Math.ceil(GUESS_COUNT / (turnOrder.length || 1));
                for (let guessIndex = 0; guessIndex < maxGuessesPerPlayer; guessIndex++) {
                    for (const playerId of turnOrder) {
                        if (totalGuessesRendered >= GUESS_COUNT) break;
                        const player = gameData.players[playerId];
                        if (player && player.guesses && player.guesses[guessIndex]) {
                            const { word, colors } = player.guesses[guessIndex];
                            renderGuess(totalGuessesRendered, word, colors);
                            totalGuessesRendered++;
                        }
                    }
                    if (totalGuessesRendered >= GUESS_COUNT) break;
                }
                
                currentRow = totalGuessesRendered;
                updateKeyboard(gameData);

                if (gameData.status === 'playing') {
                    startTurnTimer();
                } else {
                    stopTurnTimer();
                }
            }
            
            function updateScores(gameData) {
                const playerIds = Object.keys(gameData.players);
                const p1ScoreEl = document.getElementById('player1-score');
                const p2ScoreEl = document.getElementById('player2-score');
                let p1Id = (gameMode !== 'multiplayer') ? userId : (gameData.creatorId || playerIds[0]);

                if (playerIds.length > 0) {
                    const p1 = gameData.players[p1Id];
                    if(p1) p1ScoreEl.innerHTML = `<span class="font-bold">${p1.username}</span><br>${p1.score} Puan`;
                }
                 if (playerIds.length > 1) {
                    const p2Id = playerIds.find(id => id !== p1Id);
                    const p2 = gameData.players[p2Id];
                    if(p2) p2ScoreEl.innerHTML = `<span class="font-bold">${p2.username}</span><br>${p2.score} Puan`;
                } else {
                    p2ScoreEl.innerHTML = '';
                }
            }

            function updateTurnDisplay(gameData) {
                const numPlayers = Object.keys(gameData.players).length;
                shareGameBtn.classList.add('hidden');
                
                if (gameData.status === 'waiting') {
                    stopTurnTimer();
                    if (numPlayers < 2) {
                        turnDisplay.textContent = "Rakip bekleniyor...";
                        startGameBtn.classList.add('hidden');
                        shareGameBtn.classList.remove('hidden');
                    } else {
                        if (userId === gameData.creatorId) {
                            turnDisplay.textContent = "Rakip katıldı!";
                            startGameBtn.classList.remove('hidden');
                        } else {
                            turnDisplay.textContent = "Başlatılıyor...";
                            startGameBtn.classList.add('hidden');
                        }
                    }
                } else if (gameData.status === 'playing') {
                    startGameBtn.classList.add('hidden');
                    const currentPlayerUsername = gameData.players[gameData.currentPlayerId]?.username;
                    if (isMyTurn) {
                        turnDisplay.textContent = "Sıra Sende!";
                        turnDisplay.classList.add('pulsate');
                    } else {
                        turnDisplay.textContent = `Sıra: ${currentPlayerUsername}`;
                        turnDisplay.classList.remove('pulsate');
                    }
                }
            }

            function createGrid() {
                guessGrid.innerHTML = '';
                guessGrid.style.gridTemplateColumns = `repeat(${wordLength}, 1fr)`;
                for (let i = 0; i < GUESS_COUNT; i++) {
                    for (let j = 0; j < wordLength; j++) {
                        const tile = document.createElement('div');
                        tile.classList.add('tile');
                        tile.id = `tile-${i}-${j}`;
                        const tileInner = document.createElement('div');
                        tileInner.classList.add('tile-inner');
                        tile.appendChild(tileInner);
                        guessGrid.appendChild(tile);
                    }
                }
            }

            function renderGuess(rowIndex, word, colors) {
                 for (let i = 0; i < wordLength; i++) {
                    const tile = document.getElementById(`tile-${rowIndex}-${i}`);
                    if(tile) {
                        tile.querySelector('.tile-inner').textContent = word[i];
                        tile.classList.add(colors[i]);
                    }
                }
            }

            function createKeyboard() {
                keyboardContainer.innerHTML = '';
                const keyRows = [
                    ['E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P', 'Ğ', 'Ü'],
                    ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'Ş', 'İ'],
                    ['Z', 'C', 'V', 'B', 'N', 'M', 'Ö', 'Ç'],
                    ['⌫', 'ENTER']
                ];

                keyRows.forEach((row, rowIndex) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.classList.add('flex', 'justify-center', 'gap-1', 'my-1', 'w-full');
                    if(rowIndex === 3){
                         rowDiv.classList.add('gap-2');
                    }

                    row.forEach(key => {
                        const keyButton = document.createElement('button');
                        keyButton.dataset.key = key;

                        if (key === '⌫') {
                            keyButton.innerHTML = `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="#f59e0b" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z" /></svg>`;
                        } else if (key === 'ENTER') {
                            keyButton.innerHTML = `<svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4l10 6-10 6V4z"/></svg>`;
                        } else {
                            keyButton.textContent = key;
                        }
                        
                        keyButton.classList.add('keyboard-key', 'rounded', 'font-semibold', 'uppercase', 'bg-gray-500');

                        if (rowIndex === 3) {
                             keyButton.style.flex = '6';
                             keyButton.classList.add('bg-gray-600');
                        } else {
                             keyButton.style.flex = '1';
                        }

                        keyButton.onclick = () => handleKeyPress(key);
                        rowDiv.appendChild(keyButton);
                    });
                    keyboardContainer.appendChild(rowDiv);
                });
            }


            function updateKeyboard(gameData) {
                const allGuesses = Object.values(gameData.players).flatMap(p => p.guesses);
                const keyStates = {};
                allGuesses.forEach(({ word, colors }) => {
                    for (let i = 0; i < word.length; i++) {
                        const letter = word[i];
                        const color = colors[i];
                        if (keyStates[letter] === 'correct') continue;
                        if (keyStates[letter] === 'present' && color !== 'correct') continue;
                        keyStates[letter] = color;
                    }
                });
                document.querySelectorAll('.keyboard-key').forEach(btn => {
                    const keyId = btn.dataset.key;
                    if (keyId === 'ENTER' || keyId === '⌫') return;

                    const state = keyStates[keyId];
                    btn.classList.remove('correct', 'present', 'absent');
                    if (state) btn.classList.add(state);
                });
            }
            
            function startTurnTimer() {
                stopTurnTimer();
                if(isGameOver) return;

                let turnStartTime = (gameMode === 'multiplayer' && localGameData.turnStartTime?.toDate) 
                    ? localGameData.turnStartTime.toDate() 
                    : new Date();

                turnTimerInterval = setInterval(async () => {
                    let now = new Date();
                    let elapsed = Math.floor((now - turnStartTime) / 1000);
                    let timeLeft = timeLimit - elapsed;
                    
                    if(timerDisplay) {
                        if (isMyTurn) {
                            timerDisplay.textContent = timeLeft > 0 ? timeLeft : 0;
                            if (timeLeft <= 5) timerDisplay.classList.add('text-red-500');
                            else timerDisplay.classList.remove('text-red-500');
                        } else {
                             timerDisplay.textContent = timeLeft > 0 ? timeLeft : 0;
                             timerDisplay.classList.remove('text-red-500');
                        }
                    }

                    if (timeLeft <= 0 && isMyTurn) { 
                        stopTurnTimer(); 
                        await failTurn(''); 
                    }
                }, 1000);
            }

            function stopTurnTimer() {
                clearInterval(turnTimerInterval);
                turnTimerInterval = null;
                if (timerDisplay) timerDisplay.textContent = '';
            }
            
            async function failTurn(guessWord = '') {
                if (!isMyTurn) return;
                stopTurnTimer();
                keyboardContainer.style.pointerEvents = 'none';

                const newGuess = { 
                    word: guessWord.padEnd(wordLength, ' '), 
                    colors: Array(wordLength).fill('failed') 
                };

                const totalGuessesMade = Object.values(localGameData.players).reduce((acc, p) => acc + p.guesses.length, 0) + 1;

                if (gameMode === 'multiplayer') {
                    const gameRef = db.collection("games").doc(currentGameId);
                    const gameData = localGameData;

                    const playerGuesses = gameData.players[userId].guesses || [];
                    playerGuesses.push(newGuess);
                    
                    const playerIds = Object.keys(gameData.players);
                    const myIndex = playerIds.indexOf(userId);
                    const nextPlayerIndex = (myIndex + 1) % playerIds.length;
                    
                    const updates = {
                        [`players.${userId}.guesses`]: playerGuesses,
                        currentPlayerId: playerIds[nextPlayerIndex],
                        turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (totalGuessesMade >= GUESS_COUNT) {
                        updates.status = 'finished';
                        updates.roundWinner = null;
                    }
                    await gameRef.update(updates).finally(() => { keyboardContainer.style.pointerEvents = 'auto'; });
                } else {
                    localGameData.players[userId].guesses.push(newGuess);

                    if (totalGuessesMade >= GUESS_COUNT) {
                        localGameData.status = 'finished';
                        showScoreboard(localGameData);
                    } else {
                        if (gameMode === 'vsCPU') {
                            localGameData.currentPlayerId = 'cpu';
                            renderGameState(localGameData);
                            setTimeout(cpuTurn, 1500);
                        } else {
                           renderGameState(localGameData);
                        }
                    }
                    keyboardContainer.style.pointerEvents = 'auto';
                }
            }


            function handleKeyPress(key) {
                if (isGameOver || !isMyTurn) return;
                
                const processedKey = key.toLocaleUpperCase('tr-TR');
                if (processedKey === 'ENTER') {
                    playSound('click');
                    submitGuess();
                } else if (processedKey === '⌫' || processedKey === 'BACKSPACE') {
                    playSound('click');
                    deleteLetter();
                } else if (processedKey.length === 1 && "ERTYUIOPĞÜASDFGHJKLŞİZC VBNMÖÇ".includes(processedKey)) {
                    addLetter(processedKey);
                }
            }
            
            function addLetter(letter) {
                let currentGuess = '';
                for (let i = 0; i < wordLength; i++) {
                    const tile = document.getElementById(`tile-${currentRow}-${i}`);
                    if (tile && tile.querySelector('.tile-inner').textContent !== '') {
                        currentGuess += tile.querySelector('.tile-inner').textContent;
                    }
                }

                if (currentGuess.length < wordLength) {
                     for (let i = 0; i < wordLength; i++) {
                        const tile = document.getElementById(`tile-${currentRow}-${i}`);
                        if (tile && tile.querySelector('.tile-inner').textContent === '') {
                            tile.querySelector('.tile-inner').textContent = letter;
                            playSound('click');
                            break;
                        }
                    }
                } else {
                    playSound('error');
                }
            }

            function deleteLetter() {
                for (let i = wordLength - 1; i >= 0; i--) {
                    const tile = document.getElementById(`tile-${currentRow}-${i}`);
                    if (tile && tile.querySelector('.tile-inner').textContent !== '') {
                        tile.querySelector('.tile-inner').textContent = '';
                        break;
                    }
                }
            }

            async function submitGuess() {
                if (!isMyTurn) return;
                
                let guessWord = '';
                for (let i = 0; i < wordLength; i++) {
                    const tile = document.getElementById(`tile-${currentRow}-${i}`);
                    const tileInner = tile.querySelector('.tile-inner');
                    if (!tileInner || tileInner.textContent === '') { showToast("Kelime yeterince uzun değil!", true); return; }
                    guessWord += tileInner.textContent;
                }
                
                if (!kelimeSozlugu[wordLength] || !kelimeSozlugu[wordLength].includes(guessWord)) {
                    showToast("Kelime sözlükte bulunamadı!", true);
                    await failTurn(guessWord);
                    return;
                }
                
                keyboardContainer.style.pointerEvents = 'none';
                stopTurnTimer();
                
                const secretWord = localGameData.secretWord;
                const colors = calculateColors(guessWord, secretWord);
                const newGuess = { word: guessWord, colors: colors };
                const totalGuessesMade = Object.values(localGameData.players).reduce((acc, p) => acc + p.guesses.length, 0) + 1;

                if (gameMode === 'multiplayer') {
                    const gameRef = db.collection("games").doc(currentGameId);
                    const gameData = localGameData;
                    
                    const playerGuesses = gameData.players[userId].guesses || [];
                    playerGuesses.push(newGuess);

                    const playerIds = Object.keys(gameData.players);
                    const myIndex = playerIds.indexOf(userId);
                    const nextPlayerIndex = (myIndex + 1) % playerIds.length;
                    
                    const updates = {
                        [`players.${userId}.guesses`]: playerGuesses,
                        currentPlayerId: playerIds[nextPlayerIndex],
                        turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (guessWord === secretWord) {
                        updates.status = 'finished';
                        updates.roundWinner = userId;
                        const scoreToAdd = scorePoints[playerGuesses.length - 1] || 0;
                        updates[`players.${userId}.score`] = (gameData.players[userId].score || 0) + scoreToAdd;
                    } else if (totalGuessesMade >= GUESS_COUNT) {
                        updates.status = 'finished';
                        updates.roundWinner = null; 
                    }
                    await gameRef.update(updates).finally(() => { keyboardContainer.style.pointerEvents = 'auto'; });
                } else {
                    localGameData.players[userId].guesses.push(newGuess);
                    
                    if (guessWord === secretWord) {
                        localGameData.status = 'finished';
                        localGameData.roundWinner = userId;
                        const scoreToAdd = scorePoints[localGameData.players[userId].guesses.length - 1] || 0;
                        localGameData.players[userId].score += scoreToAdd;
                        showScoreboard(localGameData);
                    } else {
                        if (totalGuessesMade >= GUESS_COUNT) {
                            localGameData.status = 'finished';
                            localGameData.roundWinner = null;
                            showScoreboard(localGameData);
                        } else {
                            if (gameMode === 'vsCPU') {
                                localGameData.currentPlayerId = 'cpu';
                                renderGameState(localGameData);
                                setTimeout(cpuTurn, 1500);
                            } else {
                                renderGameState(localGameData);
                            }
                        }
                    }
                    keyboardContainer.style.pointerEvents = 'auto';
                }
            }

            function cpuTurn() {
                if (isGameOver || !localGameData || localGameData.currentPlayerId !== 'cpu') return;
                
                keyboardContainer.style.pointerEvents = 'none';

                setTimeout(() => {
                    const possibleWords = kelimeSozlugu[wordLength];
                    const guessWord = possibleWords[Math.floor(Math.random() * possibleWords.length)];

                    const secretWord = localGameData.secretWord;
                    const colors = calculateColors(guessWord, secretWord);
                    const newGuess = { word: guessWord, colors: colors };
                    localGameData.players['cpu'].guesses.push(newGuess);
                    
                    const totalGuessesMade = Object.values(localGameData.players).reduce((acc, p) => acc + p.guesses.length, 0);

                    if (guessWord === secretWord) {
                        localGameData.status = 'finished';
                        localGameData.roundWinner = 'cpu';
                        const scoreToAdd = scorePoints[localGameData.players['cpu'].guesses.length - 1] || 0;
                        localGameData.players['cpu'].score += scoreToAdd;
                        showScoreboard(localGameData);
                    } else {
                        if (totalGuessesMade >= GUESS_COUNT) {
                            localGameData.status = 'finished';
                            localGameData.roundWinner = null;
                            showScoreboard(localGameData);
                        } else {
                            localGameData.currentPlayerId = userId;
                            renderGameState(localGameData);
                        }
                    }
                    keyboardContainer.style.pointerEvents = 'auto';
                }, 1000 + Math.random() * 500);
            }
            
            async function showScoreboard(gameData) {
                stopPresenceCheck();
                stopTurnTimer();
                showScreen('scoreboard-screen');

                const roundWinnerDisplay = document.getElementById('round-winner-display');
                const correctWordDisplay = document.getElementById('correct-word-display');
                const finalScores = document.getElementById('final-scores');
                const matchWinnerDisplay = document.getElementById('match-winner-display');
                const meaningDisplay = document.getElementById('word-meaning-display');
                
                if(gameData.roundWinner === userId) playSound('win');
                else if(gameData.roundWinner === null) playSound('draw');
                else playSound('lose');

                correctWordDisplay.textContent = gameData.secretWord;
                meaningDisplay.textContent = 'Anlam yükleniyor...';
                const meaning = await fetchWordMeaning(gameData.secretWord);
                meaningDisplay.textContent = meaning;


                if (gameData.roundWinner) {
                    const winnerName = gameData.players[gameData.roundWinner].username;
                    roundWinnerDisplay.textContent = `${winnerName} Turu Kazandı!`;
                } else {
                    roundWinnerDisplay.textContent = "Berabere!";
                }

                finalScores.innerHTML = `<h3 class="text-xl font-bold mb-2 text-center">${gameMode === 'multiplayer' ? 'Toplam Puan' : 'Puan'}</h3>`;
                const sortedPlayers = Object.entries(gameData.players)
                                            .map(([id, data]) => ({...data, id}))
                                            .sort((a,b) => b.score - a.score);

                sortedPlayers.forEach(player => {
                    const scoreEl = document.createElement('p');
                    scoreEl.className = 'text-lg';
                    scoreEl.textContent = `${player.username}: ${player.score} Puan`;
                    finalScores.appendChild(scoreEl);
                });
                
                matchWinnerDisplay.textContent = '';
                newRoundBtn.textContent = (gameMode === 'multiplayer') ? 'Yeni Tur' : 'Yeni Oyun';
                newRoundBtn.classList.add('hidden');

                if (gameMode === 'multiplayer') {
                     if (gameData.currentRound >= gameData.matchLength) {
                        localStorage.removeItem('activeGameId');
                        const p1 = sortedPlayers[0];
                        const p2 = sortedPlayers.length > 1 ? sortedPlayers[1] : {score: -1};
                        if (p1.score > p2.score) {
                             matchWinnerDisplay.textContent = `MAÇI ${p1.username} KAZANDI!`;
                        } else if (p2.score > p1.score) {
                             matchWinnerDisplay.textContent = `MAÇI ${p2.username} KAZANDI!`;
                        } else {
                             matchWinnerDisplay.textContent = 'MAÇ BERABERE!';
                        }
                    } else if (userId === gameData.creatorId) {
                         newRoundBtn.classList.remove('hidden');
                    }
                } else {
                    newRoundBtn.classList.remove('hidden');
                }
            }
            
            async function startNewRound() {
                if (gameMode === 'multiplayer') {
                     if (!localGameData) return;
                    
                    const newWordList = kelimeSozlugu[localGameData.wordLength];
                    const newSecretWord = newWordList[Math.floor(Math.random() * newWordList.length)];
                    
                    const playerIds = Object.keys(localGameData.players);
                    const newPlayersState = {};
                    playerIds.forEach(pid => {
                        newPlayersState[pid] = { ...localGameData.players[pid], guesses: [] };
                    });

                    const updates = {
                        secretWord: newSecretWord, players: newPlayersState,
                        currentPlayerId: localGameData.creatorId, status: 'playing', roundWinner: null,
                        currentRound: localGameData.currentRound + 1,
                        turnStartTime: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const gameRef = db.collection("games").doc(currentGameId);
                    await gameRef.update(updates);
                    initializeGameUI(updates); // Yeni turda UI'ı yeniden oluştur
                } else {
                    if(localGameData.currentRound >= localGameData.matchLength){
                         localGameData.players[userId].score = 0; 
                         if(localGameData.players['cpu']) localGameData.players['cpu'].score = 0;
                    }
                    setupAndStartGame(gameMode);
                }
            }

            function calculateColors(guess, secret) {
                const secretLetters = secret.split('');
                const guessLetters = guess.split('');
                const colors = Array(wordLength).fill('');
                for (let i = 0; i < wordLength; i++) {
                    if (guessLetters[i] === secretLetters[i]) {
                        colors[i] = 'correct';
                        secretLetters[i] = null;
                    }
                }
                for (let i = 0; i < wordLength; i++) {
                    if (colors[i] === '') {
                        const index = secretLetters.indexOf(guessLetters[i]);
                        if (index > -1) {
                            colors[i] = 'present';
                            secretLetters[index] = null;
                        } else {
                            colors[i] = 'absent';
                        }
                    }
                }
                return colors;
            }

            async function fetchWordMeaning(word) {
                try {
                    const response = await fetch(`https://sozluk.gov.tr/gts?ara=${word.toLocaleLowerCase('tr-TR')}`);
                    const data = await response.json();
                    if (data.error) {
                        return "Anlam bulunamadı.";
                    }
                    return data[0]?.anlamlarListe?.[0]?.anlam || "Anlam bulunamadı.";
                } catch (error) {
                    console.error("Anlam alınırken hata:", error);
                    return "Anlam alınırken bir hata oluştu.";
                }
            }
            
            async function loadWords() {
                try {
                    const response = await fetch('kelimeler.json');
                    if (!response.ok) {
                        throw new Error(`Network response was not ok, status: ${response.status}`);
                    }
                    kelimeSozlugu = await response.json();
                    document.getElementById('loading-words').style.display = 'none';
                    document.getElementById('single-player-btn').disabled = false;
                    document.getElementById('vs-cpu-btn').disabled = false;
                    document.getElementById('multiplayer-btn').disabled = false;
                } catch (error) {
                    console.error("HATA: Kelime listesi yüklenirken bir sorun oluştu!", error);
                    document.getElementById('loading-words').textContent = 'Kelimeler yüklenemedi! (Hata)';
                    showToast('Kelime listesi yüklenemedi. Lütfen konsolu kontrol edin.', true);
                }
            }

            async function shareGame() {
                if (navigator.share) {
                    try {
                        const shareUrl = `${window.location.origin}${window.location.pathname}?gameId=${currentGameId}`;
                        await navigator.share({
                            title: 'Kelime Yarışması',
                            text: `Kelime Yarışması oyunuma katıl!`,
                            url: shareUrl,
                        });
                    } catch (error) { console.error('Paylaşım hatası:', error); }
                } else { showToast('Paylaşım desteklenmiyor. ID\'yi kopyalayın.', true); }
            }

            function startHeartbeat() {
                stopHeartbeat();
                heartbeatInterval = setInterval(() => {
                    if (currentGameId && db) {
                        db.collection("games").doc(currentGameId).update({
                            [`players.${userId}.lastSeen`]: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }, 10000);
            }
            function stopHeartbeat() { clearInterval(heartbeatInterval); heartbeatInterval = null; }

            function startPresenceCheck() {
                stopPresenceCheck();
                presenceCheckInterval = setInterval(() => {
                    if (!localGameData || localGameData.status !== 'playing' || isGameOver) {
                        stopPresenceCheck(); return;
                    }
                    const playerIds = Object.keys(localGameData.players);
                    if (playerIds.length < 2) return;

                    const opponentId = playerIds.find(id => id !== userId);
                    const opponent = localGameData.players[opponentId];

                    if (opponent && opponent.lastSeen) {
                        const lastSeenDate = opponent.lastSeen.toDate();
                        const secondsSinceLastSeen = (new Date().getTime() - lastSeenDate.getTime()) / 1000;
                        if (secondsSinceLastSeen > 25) {
                            handleOpponentDisconnect(opponentId);
                        }
                    }
                }, 15000);
            }
            function stopPresenceCheck() { clearInterval(presenceCheckInterval); presenceCheckInterval = null; }

            async function handleOpponentDisconnect(opponentId) {
                if (isGameOver) return;
                stopPresenceCheck();
                showToast(`${localGameData.players[opponentId].username} oyundan ayrıldı!`, true);

                const gameRef = db.collection("games").doc(currentGameId);
                const updates = { status: 'finished', roundWinner: userId };
                const scoreToAdd = scorePoints[0];
                updates[`players.${userId}.score`] = (localGameData.players[userId].score || 0) + scoreToAdd;
                await gameRef.update(updates);
            }
            
            // --- EVENT LISTENERS ---
            document.getElementById('theme-light-btn').addEventListener('click', () => { document.body.classList.add('theme-light'); });
            document.getElementById('theme-dark-btn').addEventListener('click', () => { document.body.classList.remove('theme-light'); });
            
            document.getElementById('single-player-btn').addEventListener('click', () => {
                if (getUsername()) {
                    singlePlayerMode = 'single';
                    document.getElementById('singleplayer-title').textContent = 'Tek Kişilik Oyun';
                    showScreen('singleplayer-setup-screen');
                }
            });
            document.getElementById('vs-cpu-btn').addEventListener('click', () => {
                if (getUsername()) {
                    singlePlayerMode = 'vsCPU';
                    document.getElementById('singleplayer-title').textContent = 'Bilgisayara Karşı';
                    showScreen('singleplayer-setup-screen');
                }
            });
            document.getElementById('start-single-game-btn').addEventListener('click', () => { setupAndStartGame(singlePlayerMode); });
            
            document.getElementById('multiplayer-btn').addEventListener('click', () => {
                 if (getUsername()) {
                    if(gameIdFromUrl) {
                        joinGame(gameIdFromUrl);
                    } else {
                        showScreen('multiplayer-setup-screen');
                    }
                }
            });

            document.getElementById('rejoin-game-btn').addEventListener('click', () => {
                if (getUsername()) {
                    const lastGameId = localStorage.getItem('activeGameId');
                    if (lastGameId) joinGame(lastGameId);
                }
            });

            document.getElementById('back-to-mode-single-btn').addEventListener('click', () => showScreen('mode-selection-screen'));
            document.getElementById('back-to-mode-multi-btn').addEventListener('click', () => showScreen('mode-selection-screen'));
            leaveGameBtn.onclick = leaveGame;
            createBtn.addEventListener('click', createGame);
            joinBtn.addEventListener('click', () => { const gameId = document.getElementById('game-id-input').value.toUpperCase(); joinGame(gameId); });
            copyGameIdBtn.addEventListener('click', () => { const gameId = gameIdDisplay.textContent; navigator.clipboard.writeText(gameId).then(() => { showToast('Oyun ID kopyalandı!'); }); });
            shareGameBtn.addEventListener('click', shareGame);
            startGameBtn.addEventListener('click', async () => { if (!currentGameId || gameMode !== 'multiplayer') return; const gameRef = db.collection("games").doc(currentGameId); await gameRef.update({ status: 'playing', turnStartTime: firebase.firestore.FieldValue.serverTimestamp() }); });
            document.addEventListener('keydown', (e) => { if (e.ctrlKey || e.altKey || e.metaKey) return; handleKeyPress(e.key); });
            mainMenuBtn.addEventListener('click', leaveGame);
            newRoundBtn.addEventListener('click', startNewRound);

            // --- Game Startup Logic ---
            async function initializeApp() {
                await loadWords();
                const urlParams = new URLSearchParams(window.location.search);
                gameIdFromUrl = urlParams.get('gameId');

                const lastGameId = localStorage.getItem('activeGameId');
                if(lastGameId) {
                    document.getElementById('rejoin-game-btn').classList.remove('hidden');
                }
                
                 if (typeof firebase === 'undefined') {
                    showToast("Firebase kütüphanesi yüklenemedi.", true); return;
                }
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            userId = user.uid;
                            createBtn.disabled = false;
                            joinBtn.disabled = false;
                            
                            if (gameIdFromUrl && !currentGameId) {
                                document.getElementById('username-input').value = `Misafir${Math.floor(Math.random() * 900) + 100}`;
                                joinGame(gameIdFromUrl);
                                gameIdFromUrl = null;
                            }
                        } else {
                            auth.signInAnonymously().catch(error => { 
                                console.error("Firebase anonim giriş başarısız!", error); 
                                showToast("Bağlantı hatası!", true);
                            });
                        }
                    });
                } catch (e) {
                    console.error("Firebase başlatılırken bir sorun oluştu!", e);
                    showToast("Uygulama başlatılamadı.", true);
                }
            }
            
            initializeApp();
        });
    </script>
</body>
</html>